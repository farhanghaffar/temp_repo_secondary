name: Deploy Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Set HEADLESS environment variable (headless run)
      run: echo "HEADLESS=true" >> $GITHUB_ENV

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.x
    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip
        pip install allure-behave
        pip --version
    
    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Run Behave tests
      run: behave NavigoPlatform/Features/RouterFeature/Login.feature -f allure_behave.formatter:AllureFormatter -o allure-results

    - name: Upload Allure results
      uses: actions/upload-artifact@v2
      with:
        name: allure-results
        path: allure-results

  report:
    runs-on: ubuntu-latest

    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Check Java Version
      run: java -version
      
    - name: Install Allure Command Line
      run: |
        curl -o allure-2.24.1.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz
        tar -zxvf allure-2.24.1.tgz -C /tmp
        sudo mv /tmp/allure-2.24.1/bin/allure /usr/local/bin/
    - name: Run Behave tests in Allure Docker container
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace qameta/allure:2.24.1-behave allure behave NavigoPlatform/Features/RouterFeature/Login.feature -o allure-results
    
    - name: Download Allure results
      uses: actions/download-artifact@v2
      with:
        name: allure-results

    - name: Generate Allure Report
      run: allure generate allure-results -o allure-report --clean

    - name: Open Allure Report
      run: allure open allure-report
